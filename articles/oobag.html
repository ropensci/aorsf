<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="aorsf">
<title>Out-of-bag predictions and evaluation • aorsf</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Out-of-bag predictions and evaluation">
<meta property="og:description" content="aorsf">
<meta property="og:image" content="https://bcjaeger.github.io/aorsf/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">aorsf</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/aorsf.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/pd.html">Compute partial dependence with ORSF</a>
    <a class="dropdown-item" href="../articles/oobag.html">Out-of-bag predictions and evaluation</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/bcjaeger/aorsf/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="oobag_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Out-of-bag predictions and evaluation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bcjaeger/aorsf/blob/HEAD/vignettes/oobag.Rmd" class="external-link"><code>vignettes/oobag.Rmd</code></a></small>
      <div class="d-none name"><code>oobag.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bcjaeger/aorsf" class="external-link">aorsf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">survivalROC</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="out-of-bag-data">Out-of-bag data<a class="anchor" aria-label="anchor" href="#out-of-bag-data"></a>
</h2>
<p>In random forests, each tree is grown with a bootstrapped version of the training set. Because bootstrap samples are selected with replacement, each bootstrapped training set contains about two-thirds of instances in the original training set. The ‘out-of-bag’ data are instances that are <em>not</em> in the bootstrapped training set.</p>
</div>
<div class="section level2">
<h2 id="out-of-bag-predictions-and-error">Out-of-bag predictions and error<a class="anchor" aria-label="anchor" href="#out-of-bag-predictions-and-error"></a>
</h2>
<p>Each tree in the random forest can make predictions for its out-of-bag data, and the out-of-bag predictions can be aggregated to make an ensemble out-of-bag prediction. Since the out-of-bag data are not used to grow the tree, the accuracy of the ensemble out-of-bag predictions approximate the generalization error of the random forest. Out-of-bag prediction error plays a central role for some routines that estimate variable importance, e.g. negation importance.</p>
<p>Let’s fit an oblique random survival forest and plot the distribution of the ensemble out-of-bag predictions.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/orsf.html">orsf</a></span><span class="op">(</span>data_train <span class="op">=</span> <span class="va">pbc_orsf</span>, </span>
<span>            formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="va">id</span>,</span>
<span>            oobag_time <span class="op">=</span> <span class="fl">3500</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">surv_oobag</span>, </span>
<span>     main <span class="op">=</span> <span class="st">'Ensemble out-of-bag survival predictions at t=3,500'</span><span class="op">)</span></span></code></pre></div>
<p><img src="oobag_files/figure-html/unnamed-chunk-2-1.png" width="672"></p>
<p>Not surprisingly, all of the survival predictions are between 0 and 1. Next, let’s check the out-of-bag accuracy of <code>fit</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># what function is used to evaluate out-of-bag predictions?</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">eval_oobag</span><span class="op">$</span><span class="va">stat_type</span></span>
<span><span class="co">#&gt; [1] "Harrell's C-statistic"</span></span>
<span></span>
<span><span class="co"># what is the output from this function?</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">eval_oobag</span><span class="op">$</span><span class="va">stat_values</span></span>
<span><span class="co">#&gt;           [,1]</span></span>
<span><span class="co">#&gt; [1,] 0.8412169</span></span></code></pre></div>
<p>The out-of-bag estimate of Harrell’s C-statistic (the default method to evaluate out-of-bag predictions) is 0.8412169.</p>
</div>
<div class="section level2">
<h2 id="monitoring-out-of-bag-error">Monitoring out-of-bag error<a class="anchor" aria-label="anchor" href="#monitoring-out-of-bag-error"></a>
</h2>
<p>As each out-of-bag data set contains about one-third of the training set, the out-of-bag error estimate usually converges to a stable value as more trees are added to the forest. If you want to monitor the convergence of out-of-bag error for your own oblique random survival forest, you can set <code>oobag_eval_every</code> to compute out-of-bag error at every <code>oobag_eval_every</code> tree. For example, let’s compute out-of-bag error after fitting each tree in a forest of 50 trees:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/orsf.html">orsf</a></span><span class="op">(</span>data_train <span class="op">=</span> <span class="va">pbc_orsf</span>,</span>
<span>            formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="va">id</span>,</span>
<span>            n_tree <span class="op">=</span> <span class="fl">50</span>,</span>
<span>            oobag_time <span class="op">=</span> <span class="fl">3500</span>,</span>
<span>            oobag_eval_every <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span> x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">50</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span> y <span class="op">=</span> <span class="va">fit</span><span class="op">$</span><span class="va">eval_oobag</span><span class="op">$</span><span class="va">stat_values</span>, </span>
<span> main <span class="op">=</span> <span class="st">'Out-of-bag C-statistic computed after each new tree is grown.'</span>,</span>
<span> xlab <span class="op">=</span> <span class="st">'Number of trees grown'</span>,</span>
<span> ylab <span class="op">=</span> <span class="va">fit</span><span class="op">$</span><span class="va">eval_oobag</span><span class="op">$</span><span class="va">stat_type</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="oobag_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
<p>In general, at least 500 trees are recommended for a random forest fit. We’re just using 50 in this case for better illustration of the out-of-bag error curve. Also, it helps to make run-times low whenever I need to re-compile the package vignettes.</p>
</div>
<div class="section level2">
<h2 id="user-supplied-out-of-bag-evaluation-functions">User-supplied out-of-bag evaluation functions<a class="anchor" aria-label="anchor" href="#user-supplied-out-of-bag-evaluation-functions"></a>
</h2>
<p>In some cases, you may want to use your own function to compute out-of-bag error. For example, here is a simple (and incorrect) way to compute the Brier score. (It is incorrect because it does not account for censoring)</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">oobag_fun_brier</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y_mat</span>, <span class="va">s_vec</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span> <span class="co"># risk = 1 - survival </span></span>
<span> <span class="va">r_vec</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">s_vec</span></span>
<span></span>
<span> <span class="co"># mean of the squared differences between predicted and observed risk</span></span>
<span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span> <span class="op">(</span><span class="va">y_mat</span><span class="op">[</span>, <span class="st">'status'</span><span class="op">]</span> <span class="op">-</span> <span class="va">r_vec</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">)</span></span>
<span> </span>
<span><span class="op">}</span></span></code></pre></div>
<p>There are two ways to apply your own function to compute out-of-bag error. First, you can apply your function to the out-of-bag survival predictions that are stored in ‘aorsf’ objects, e.g:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu">oobag_fun_brier</span><span class="op">(</span>y_mat <span class="op">=</span> <span class="va">fit</span><span class="op">$</span><span class="va">data_train</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'time'</span>, <span class="st">'status'</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                s_vec <span class="op">=</span> <span class="va">fit</span><span class="op">$</span><span class="va">surv_oobag</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.1868415</span></span></code></pre></div>
<p>Second, you can pass your function into <code><a href="../reference/orsf.html">orsf()</a></code>, and it will be used in place of Harrell’s C-statistic:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/orsf.html">orsf</a></span><span class="op">(</span>data_train <span class="op">=</span> <span class="va">pbc_orsf</span>,</span>
<span>            formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="va">id</span>,</span>
<span>            n_tree <span class="op">=</span> <span class="fl">50</span>,</span>
<span>            oobag_time <span class="op">=</span> <span class="fl">3500</span>,</span>
<span>            oobag_fun <span class="op">=</span> <span class="va">oobag_fun_brier</span>,</span>
<span>            oobag_eval_every <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span> x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">50</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span> y <span class="op">=</span> <span class="va">fit</span><span class="op">$</span><span class="va">eval_oobag</span><span class="op">$</span><span class="va">stat_values</span>, </span>
<span> main <span class="op">=</span> <span class="st">'Out-of-bag error computed after each new tree is grown.'</span>,</span>
<span> sub <span class="op">=</span> <span class="st">'For the Brier score, lower values indicate more accurate predictions'</span>,</span>
<span> xlab <span class="op">=</span> <span class="st">'Number of trees grown'</span>,</span>
<span> ylab <span class="op">=</span> <span class="st">"Brier score"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="oobag_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
<p>Let’s run one more example showing how this can be done using functions from other packages, e.g., <code>survivalROC</code> from the <code>survivalROC</code> package:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">oobag_fun_sroc</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y_mat</span>, <span class="va">s_vec</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span> <span class="va">score</span> <span class="op">&lt;-</span> <span class="fu">survivalROC</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survivalROC/man/survivalROC.html" class="external-link">survivalROC</a></span><span class="op">(</span></span>
<span>  Stime <span class="op">=</span> <span class="va">y_mat</span><span class="op">[</span>, <span class="st">'time'</span><span class="op">]</span>,</span>
<span>  status <span class="op">=</span> <span class="va">y_mat</span><span class="op">[</span>, <span class="st">'status'</span><span class="op">]</span>,</span>
<span>  <span class="co"># risk = 1 - survival</span></span>
<span>  marker <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">s_vec</span>,</span>
<span>  <span class="co"># important!! Make sure this matches the time you used in orsf</span></span>
<span>  predict.time <span class="op">=</span> <span class="fl">3500</span>,</span>
<span>  <span class="co"># nearest neighbor estimation for censoring</span></span>
<span>  method <span class="op">=</span> <span class="st">"NNE"</span>,</span>
<span>  <span class="co"># value taken from ?survivalROC examples</span></span>
<span>  span <span class="op">=</span> <span class="fl">0.25</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">y_mat</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">0.20</span><span class="op">)</span></span>
<span> <span class="op">)</span></span>
<span> </span>
<span> <span class="co"># oobag_fun needs to return a numeric value of length 1</span></span>
<span> <span class="va">score</span><span class="op">$</span><span class="va">AUC</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/orsf.html">orsf</a></span><span class="op">(</span>data_train <span class="op">=</span> <span class="va">pbc_orsf</span>,</span>
<span>            formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="va">id</span>,</span>
<span>            n_tree <span class="op">=</span> <span class="fl">50</span>,</span>
<span>            oobag_time <span class="op">=</span> <span class="fl">3500</span>,</span>
<span>            oobag_fun <span class="op">=</span> <span class="va">oobag_fun_sroc</span>,</span>
<span>            oobag_eval_every <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span> x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span>,</span>
<span> y <span class="op">=</span> <span class="va">fit</span><span class="op">$</span><span class="va">eval_oobag</span><span class="op">$</span><span class="va">stat_values</span>, </span>
<span> main <span class="op">=</span> <span class="st">'Out-of-bag time-dependent AUC\ncomputed after each new tree is grown.'</span>,</span>
<span> xlab <span class="op">=</span> <span class="st">'Number of trees grown'</span>,</span>
<span> ylab <span class="op">=</span> <span class="st">"AUC at t = 3,500"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="oobag_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
<div class="section level3">
<h3 id="specific-instructions-on-user-supplied-functions">Specific instructions on user-supplied functions<a class="anchor" aria-label="anchor" href="#specific-instructions-on-user-supplied-functions"></a>
</h3>
<p>User-supplied functions must:</p>
<ol style="list-style-type: decimal">
<li>have exactly two arguments named <code>y_mat</code> and <code>s_vec</code>.</li>
<li>return a numeric output of length 1</li>
</ol>
<p>If either of these conditions is not true, an error will occur. A simple test to make sure your user-supplied function will work with the aorsf package is below:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Helper code to make sure your oobag_fun function will work with aorsf</span></span>
<span></span>
<span><span class="co"># time and status values</span></span>
<span><span class="va">test_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">1</span>, to <span class="op">=</span> <span class="fl">5</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">test_status</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># y-matrix is presumed to contain time and status (with column names)</span></span>
<span><span class="va">y_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">test_time</span>, status <span class="op">=</span> <span class="va">test_status</span><span class="op">)</span></span>
<span><span class="co"># s_vec is presumed to be a vector of survival probabilities</span></span>
<span><span class="va">s_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.9</span>, <span class="fl">0.1</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># see 1 in the checklist above</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/formals.html" class="external-link">formals</a></span><span class="op">(</span><span class="va">oobag_fun_sroc</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"y_mat"</span>, <span class="st">"s_vec"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE TRUE</span></span>
<span></span>
<span><span class="va">test_output</span> <span class="op">&lt;-</span> <span class="fu">oobag_fun_sroc</span><span class="op">(</span>y_mat <span class="op">=</span> <span class="va">y_mat</span>, s_vec <span class="op">=</span> <span class="va">s_vec</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># test output should be numeric</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">test_output</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co"># test_output should be a numeric value of length 1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">test_output</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="user-supplied-functions-for-negation-importance-">User-supplied functions for negation importance.<a class="anchor" aria-label="anchor" href="#user-supplied-functions-for-negation-importance-"></a>
</h2>
<p>Negation importance is based on the out-of-bag error, so of course you may be curious about what negation importance would be if it were computed using different statistics. The workflow for doing this is exactly the same as the example above, except we have to specify <code>importance = 'negate'</code> when we fit our model. Also, to speed up computations, I am not going to monitor out-of-bag error here.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">fit_sroc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/orsf.html">orsf</a></span><span class="op">(</span>data_train <span class="op">=</span> <span class="va">pbc_orsf</span>,</span>
<span>                 formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="va">id</span>,</span>
<span>                 n_tree <span class="op">=</span> <span class="fl">50</span>,</span>
<span>                 oobag_time <span class="op">=</span> <span class="fl">3500</span>,</span>
<span>                 oobag_fun <span class="op">=</span> <span class="va">oobag_fun_sroc</span>,</span>
<span>                 importance <span class="op">=</span> <span class="st">'negate'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_sroc</span><span class="op">$</span><span class="va">importance</span></span>
<span><span class="co">#&gt;         bili      albumin        sex_f     hepato_1      protime      edema_1 </span></span>
<span><span class="co">#&gt;  0.041395032  0.036650402  0.032469846  0.008237815  0.007584568  0.006152816 </span></span>
<span><span class="co">#&gt;       copper    spiders_1          ast    ascites_1    edema_0.5        stage </span></span>
<span><span class="co">#&gt;  0.004135567  0.001953243  0.001261592 -0.007687205 -0.008428337 -0.011173128 </span></span>
<span><span class="co">#&gt;     platelet     alk.phos  trt_placebo         chol         trig          age </span></span>
<span><span class="co">#&gt; -0.011929203 -0.014388983 -0.015838587 -0.018945968 -0.019685804 -0.020250757</span></span></code></pre></div>
<div class="section level3">
<h3 id="multiple-functions-for-negation-importance">Multiple functions for negation importance<a class="anchor" aria-label="anchor" href="#multiple-functions-for-negation-importance"></a>
</h3>
<p>If you’d like to compute several types of negation importance for the same model, that can be done using <code><a href="../reference/orsf_vi_negate.html">orsf_vi_negate()</a></code>, which allows you to specify an out-of-bag function just as <code><a href="../reference/orsf.html">orsf()</a></code> does:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/orsf.html">orsf</a></span><span class="op">(</span>data_train <span class="op">=</span> <span class="va">pbc_orsf</span>,</span>
<span>            formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="va">id</span>,</span>
<span>            n_tree <span class="op">=</span> <span class="fl">500</span>,</span>
<span>            oobag_time <span class="op">=</span> <span class="fl">3500</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># use default technique (harrell's C-statistic)</span></span>
<span><span class="fu"><a href="../reference/orsf_vi_negate.html">orsf_vi_negate</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt;          bili           age         stage       ascites       protime </span></span>
<span><span class="co">#&gt;  1.833715e-02  1.161700e-02  7.084809e-03  5.990831e-03  5.938737e-03 </span></span>
<span><span class="co">#&gt;        copper       spiders           ast           sex         edema </span></span>
<span><span class="co">#&gt;  5.782455e-03  5.730360e-03  3.750781e-03  3.438216e-03  2.829210e-03 </span></span>
<span><span class="co">#&gt;        hepato          chol      platelet           trt       albumin </span></span>
<span><span class="co">#&gt;  2.813086e-03  1.562826e-03  5.209419e-05 -3.646593e-04 -1.146072e-03 </span></span>
<span><span class="co">#&gt;          trig      alk.phos </span></span>
<span><span class="co">#&gt; -3.073557e-03 -3.646593e-03</span></span>
<span></span>
<span><span class="co"># use C-statistic from survivalROC</span></span>
<span><span class="fu"><a href="../reference/orsf_vi_negate.html">orsf_vi_negate</a></span><span class="op">(</span><span class="va">fit</span>, oobag_fun <span class="op">=</span> <span class="va">oobag_fun_sroc</span><span class="op">)</span></span>
<span><span class="co">#&gt;          bili           ast        hepato         stage      alk.phos </span></span>
<span><span class="co">#&gt;  0.0374073582  0.0152786731  0.0085005478  0.0033108882  0.0019084888 </span></span>
<span><span class="co">#&gt;       protime       albumin          chol      platelet           sex </span></span>
<span><span class="co">#&gt;  0.0011721339  0.0004046745 -0.0026888423 -0.0037853699 -0.0057037133 </span></span>
<span><span class="co">#&gt;         edema       ascites           age        copper          trig </span></span>
<span><span class="co">#&gt; -0.0065206178 -0.0095167361 -0.0101714820 -0.0134515797 -0.0155921079 </span></span>
<span><span class="co">#&gt;       spiders           trt </span></span>
<span><span class="co">#&gt; -0.0165157571 -0.0240883625</span></span>
<span></span>
<span><span class="co"># you can also use custom functions for permutation importance</span></span>
<span><span class="fu"><a href="../reference/orsf_vi_negate.html">orsf_vi_permute</a></span><span class="op">(</span><span class="va">fit</span>, oobag_fun <span class="op">=</span> <span class="va">oobag_fun_sroc</span><span class="op">)</span></span>
<span><span class="co">#&gt;        hepato          bili           ast      alk.phos       albumin </span></span>
<span><span class="co">#&gt;  0.0270528997  0.0206997042  0.0206355996  0.0148064897  0.0141336010 </span></span>
<span><span class="co">#&gt;         stage          chol       protime      platelet         edema </span></span>
<span><span class="co">#&gt;  0.0048439563  0.0022662813  0.0001194072 -0.0003626576 -0.0027790113 </span></span>
<span><span class="co">#&gt;       ascites          trig       spiders           sex           trt </span></span>
<span><span class="co">#&gt; -0.0042110767 -0.0075917998 -0.0077786101 -0.0084401113 -0.0112396101 </span></span>
<span><span class="co">#&gt;           age        copper </span></span>
<span><span class="co">#&gt; -0.0141228001 -0.0153267521</span></span></code></pre></div>
<p>There are some discrepancies between methods in the ranking of important variables. A simulation study to determine which method of estimating out-of-bag error does a better job of discriminating between important and unimportant variables would be helpful.</p>
</div>
</div>
<div class="section level2">
<h2 id="i-really-need-to-use">I really need to use <package x></package><a class="anchor" aria-label="anchor" href="#i-really-need-to-use"></a>
</h2>
<p>You can use any package whatsoever to evaluate out-of-bag predictions. You can access the final out-of-bag survival predictions from an <code>aorsf</code> model like so:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">surv_oobag</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">surv_oobag</span></span>
<span></span>
<span><span class="va">surv_oobag</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="op">]</span></span>
<span><span class="co">#&gt; [1] 0.01002748 0.44316724 0.14709872 0.24368105 0.29502397</span></span></code></pre></div>
<p>Some notes to remember when evaluating out-of-bag error with <code>surv_oobag</code>:</p>
<ul>
<li><p>the <code>oobag_time</code> input in <code><a href="../reference/orsf.html">orsf()</a></code> determines the prediction horizon for out-of-bag predictions. The prediction horizon is a critical input for evaluation of predictions with time-to-event outcomes.</p></li>
<li><p>Some functions expect predicted risk (i.e., 1 - predicted survival), others expect predicted survival.</p></li>
</ul>
<p>In most cases, you should also be able to use any package whatsoever to compute negation importance. One exception at this point is <code>riskRegression</code>. I have experimented with <code>riskRegression</code> but found its functions do not work as I would expect them to when I try to run them from C++. I think this may be due to <code>riskRegression</code>’s internal use of <code>data.table</code> and modification by reference, but I do not have certainty on that yet.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Byron Jaeger.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
